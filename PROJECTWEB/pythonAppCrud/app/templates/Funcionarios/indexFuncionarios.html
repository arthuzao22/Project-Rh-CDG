{% load static %}
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Hugo 0.84.0">
  <title>Funcionarios</title>

  <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/dashboard/">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <!-- Bootstrap core CSS -->
  <link href="{% static 'css/dashboard.css' %}" rel="stylesheet">
  <link href="{% static 'css/dashboard.rtl.css' %}" rel="stylesheet">


  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }

    th {
      text-align: center;
    }

    tr {
      text-align: center;
      white-space: nowrap;
    }

    .table {
      border: 1px solid black;
      /* Borda na tabela */
      border-collapse: collapse;
      /* Colapsa as bordas para que não haja espaço entre elas */
    }

    .table th,
    .table td {
      border: 1px solid black;
      /* Borda nas células */
      padding: 8px;
      /* Espaçamento interno para as células */
    }

    .table th {
      background-color: #f2f2f2;
      /* Cor de fundo opcional para cabeçalho */
    }
  </style>

</head>

<body>

  <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">CDG</a>
    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse"
      data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="navbar-nav">
      <div class="nav-item text-nowrap">
        <a class="nav-link px-3" href="#">Sign out</a>
      </div>
    </div>
  </header>

  <div class="container-fluid">
    <div class="row">
      <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="/home">
                <span data-feather="home"></span>
                Home
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/indexFuncionarios">
                <span data-feather="file"></span>
                Funcionarios
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/manipulate_funcionarios">
                <span data-feather="shopping-cart"></span>
                Salario calculado
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/index_salario">
                <span data-feather="users"></span>
                Edit. salario
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <span data-feather="bar-chart-2"></span>
                Reports
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <span data-feather="layers"></span>
                Integrations
              </a>
            </li>
          </ul>

          <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
            <span>Saved reports</span>
            <a class="link-secondary" href="#" aria-label="Add a new report">
              <span data-feather="plus-circle"></span>
            </a>
          </h6>
          <ul class="nav flex-column mb-2">
            <li class="nav-item">
              <a class="nav-link" href="#">
                <span data-feather="file-text"></span>
                Current month
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <span data-feather="file-text"></span>
                Last quarter
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <span data-feather="file-text"></span>
                Social engagement
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <span data-feather="file-text"></span>
                Year-end sale
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <div class="container-fluid">
        <div class="row">
          <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div
              class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Funcionarios</h1>
              <form method="GET" action="{% url 'indexFuncionarios' %}" class="mb-2 mb-md-0">
                <div class="row">
                  <div class="col">
                    <select id="status" name="status" class="btn btn-sm btn-outline-secondary">
                      <option value="">Selecione um status</option>
                      <option value="Ativo">Ativo</option>
                      <option value="Inativo">Inativo</option>
                    </select>
                  </div>
                  <div class="col">
                    <div class="btn-toolbar">
                      <div class="btn-group me-2">
                        <button type="submit" class="btn btn-sm btn-outline-secondary">Filtrar</button>
                        <a href="/form" class="btn btn-sm btn-outline-secondary">Adicionar</a>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>


            <div class="row">
              {% for funcionario in db %}
              <div class="col-sm-12 col-md-6 col-lg-4 d-flex">
                <div class="card mb-3 shadow-sm flex-grow-1" style="border-radius: 12px; min-width: 280px;">
                  <div class="row g-0">
                    <div class="col-md-4">
                      <img
                        src="https://thumbs.dreamstime.com/b/homem-cinzento-do-placeholder-da-foto-pessoa-gen%C3%A9rica-silhueta-cinzenta-em-um-fundo-branco-144511705.jpg"
                        class="img-fluid rounded-start" alt="Foto do Funcionário">
                    </div>
                    <div class="col-md-8">
                      <div class="card-body">
                        <h5 class="card-title">{{ funcionario.nome }}</h5>
                        <p class="card-text">Registro: {{ funcionario.registro }}<br>Função: {{ funcionario.funcao }}
                        </p>
                        <p class="card-text"><small class="text-muted">{{ funcionario.status }}</small></p>
                        <div class="mt-2">
                          <a onclick="view('{{ funcionario.id }}')" class="btn btn-outline-primary btn-sm me-2">Visualizar</a>
                            
                          <a onclick="edit('{{ funcionario.id }}')" class="btn btn-outline-warning btn-sm me-2">Editar</a>

                          <a onclick="deletar({{ funcionario.id }}, {{ nome }})" class="btn btn-outline-danger btn-sm me-2">Deletar</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="col-12">
                <div class="alert alert-warning text-center" role="alert">
                  Nenhum funcionário encontrado.
                </div>
              </div>
              {% endfor %}
            </div>
          </main>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="staticBackdropLabel">Deletar</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Voce tem certeza que deseja excluir? {{funcionario}}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" id="confirmDelete" class="btn btn-primary">Confirmar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- view -->
      <div class="modal fade" id="view" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-black text-white">
              <h5 class="modal-title" id="exampleModalLabel">Visualizar Funcionário</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="card border-primary mb-3">
                <div class="card-body">
                  <h5 class="card-title"><strong>Nome:</strong> <span id="nomeFuncionario"></span></h5>
                  <p class="card-text"><strong>Registro:</strong> <span id="registroFuncionario"></span></p>
                  <p class="card-text"><strong>Função:</strong> <span id="funcaoFuncionario"></span></p>
                  <p class="card-text"><strong>Data de Nascimento:</strong> <span id="dataNascimento"></span></p>
                  <p class="card-text"><strong>Data de Admissão:</strong> <span id="dataAdmissao"></span></p>
                  <p class="card-text"><strong>CPF:</strong> <span id="cpfFuncionario"></span></p>
                  <p class="card-text"><strong>Conta Inter:</strong> <span id="contaInter"></span></p>
                  <p class="card-text"><strong>Último Exame:</strong> <span id="ultimoExame"></span></p>
                  <p class="card-text"><strong>Próximo Exame:</strong> <span id="proximoExame"></span></p>
                  <p class="card-text"><strong>Email:</strong> <span id="emailFuncionario"></span></p>
                  <p class="card-text"><strong>Salário:</strong> R$ <span id="salarioFuncionario"></span></p>
                  <p class="card-text"><strong>Status:</strong> <span id="statusFuncionario"></span></p>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- edit -->
<div class="modal fade" id="edit" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header bg-black text-white">
              <h5 class="modal-title" id="exampleModalLabel">Editar funcionário - </h5>
              <h5 class="modal-title" id="nomeFuncionario"></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div class="card border-primary mb-3">
                  <div class="card-body">
                      {% csrf_token %}
                      <input type="hidden" id="id" name="id"> <!-- Campo oculto para o ID do funcionário -->
                      <div class="form-group">
                          <label for="nome">Nome:</label>
                          <input type="text" id="nome" name="nome" class="form-control" value="{{ form.nome.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="registro">Registro:</label>
                          <input type="text" id="registro" name="registro" class="form-control" value="{{ form.registro.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="funcao">Função:</label>
                          <input type="text" id="funcao" name="funcao" class="form-control" value="{{ form.funcao.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="data_nascimento">Data de Nascimento:</label>
                          <input type="date" id="data_nascimento" name="data_nascimento" class="form-control" value="{{ form.data_nascimento.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="data_admissao">Data de Admissão:</label>
                          <input type="date" id="data_admissao" name="data_admissao" class="form-control" value="{{ form.data_admissao.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="cpf">CPF:</label>
                          <input type="text" id="cpf" name="cpf" class="form-control" value="{{ form.cpf.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="conta_inter">Conta Inter:</label>
                          <input type="text" id="conta_inter" name="conta_inter" class="form-control" value="{{ form.conta_inter.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="ultimo_exame">Último Exame:</label>
                          <input type="date" id="ultimo_exame" name="ultimo_exame" class="form-control" value="{{ form.ultimo_exame.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="proximo_exame">Próximo Exame:</label>
                          <input type="date" id="proximo_exame" name="proximo_exame" class="form-control" value="{{ form.proximo_exame.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="email">Email:</label>
                          <input type="email" id="email" name="email" class="form-control" value="{{ form.email.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                          <label for="cargo">Cargo:</label>
                          <select id="cargo" name="cargo" class="form-control">
                              <option value="Estagiario" {% if form.cargo.value == "Estagiario" %}selected{% endif %}>Estagiario</option>
                              <option value="CLT" {% if form.cargo.value == "CLT" %}selected{% endif %}>CLT</option>
                              <option value="PJ" {% if form.cargo.value == "PJ" %}selected{% endif %}>PJ</option>
                              <option value="outros" {% if form.cargo.value == "outros" %}selected{% endif %}>Outros</option>
                          </select>
                      </div>
                      <div class="form-group">
                          <label for="salario">Salário:</label>
                          <input type="number" step="0.01" id="salario" name="salario" class="form-control" value="{{ form.salario.value|default_if_none:'' }}">
                      </div>
                      <div class="form-group">
                        <label for="status">Status:</label>
                        <select id="status" name="status" class="form-control">
                            <option value="Ativo" {% if form.status.value == "Ativo" %}selected{% endif %}>Ativo</option>
                            <option value="Inativo" {% if form.status.value == "Inativo" %}selected{% endif %}>Inativo</option>
                        </select>
                    </div>
                      <input type="submit" onclick="update(event)" class="btn btn-success" value="Salvar"> <!-- Passa o evento para a função -->
                  </div>
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
      </div>
  </div>
</div>

      <script>
        // Função para exibir o modal e preparar a ação de deletar
        function deletar(funcionario, usuarioId) {
          console.log(funcionario)
          var myModal = new bootstrap.Modal(document.getElementById('staticBackdrop'));
          myModal.show();

          document.getElementById('confirmDelete').onclick = function () {
            window.location.href = `/delete/${funcionario}/`;
            console.log('Deleting item with planfuncionarioId:', planfuncionarioId, 'and usuarioId:', usuarioId);

            myModal.hide();
          }
        }

        function view(funcionarioId) {
          var myModal = new bootstrap.Modal(document.getElementById('view'));
          myModal.show();

          fetch(`/view/${funcionarioId}/`)  // Certifique-se de que esta URL está correta
            .then(response => {
              if (!response.ok) {
                throw new Error('Erro na rede: ' + response.statusText);
              }
              return response.json();
            })
            .then(data => {
              // Preenchendo os elementos HTML com os dados recebidos
              document.getElementById('nomeFuncionario').innerText = data.nome || 'N/A';
              document.getElementById('registroFuncionario').innerText = data.registro || 'N/A';
              document.getElementById('funcaoFuncionario').innerText = data.funcao || 'N/A';
              document.getElementById('dataNascimento').innerText = data.data_nascimento || 'N/A';
              document.getElementById('dataAdmissao').innerText = data.data_admissao || 'N/A';
              document.getElementById('cpfFuncionario').innerText = data.cpf || 'N/A';
              document.getElementById('contaInter').innerText = data.conta_inter || 'N/A';
              document.getElementById('ultimoExame').innerText = data.ultimo_exame || 'N/A';
              document.getElementById('proximoExame').innerText = data.proximo_exame || 'N/A';
              document.getElementById('emailFuncionario').innerText = data.email || 'N/A';
              document.getElementById('salarioFuncionario').innerText = data.salario || 'N/A';
              document.getElementById('statusFuncionario').innerText = data.status || 'N/A';
            })
            .catch(error => console.error('Erro:', error));
        }

        function edit(funcionarioId) {
          var myModal = new bootstrap.Modal(document.getElementById('edit'));
          myModal.show();
          
          fetch(`/edit/${funcionarioId}/`)  // Ensure this URL is correct
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              document.getElementById('id').value = funcionarioId || '';
              document.getElementById('nome').value = data.nome || '';
              document.getElementById('registro').value = data.registro || '';
              document.getElementById('funcao').value = data.funcao || '';
              document.getElementById('data_nascimento').value = data.data_nascimento || '';
              document.getElementById('data_admissao').value = data.data_admissao || '';
              document.getElementById('cpf').value = data.cpf || '';
              document.getElementById('conta_inter').value = data.conta_inter || '';
              document.getElementById('ultimo_exame').value = data.ultimo_exame || '';
              document.getElementById('proximo_exame').value = data.proximo_exame || '';
              document.getElementById('email').value = data.email || '';
              document.getElementById('salario').value = data.salario || '';
              document.getElementById('cargo').value = data.cargo || ''; // default to Estagiario
              document.getElementById('status').value = data.status || ''; // default to Ativo
            })
            .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while fetching the data. Please try again.');
            });
        }      
          
        function update(event) {
          event.preventDefault(); // Previne o envio padrão do formulário
          
          // Obtenha o ID do funcionário do campo oculto
          const funcionarioId = document.getElementById('id').value;
        
          // Obtenha os valores do formulário
          const nome = document.getElementById('nome').value;
          const registro = document.getElementById('registro').value;
          const funcao = document.getElementById('funcao').value;
          const data_nascimento = document.getElementById('data_nascimento').value;
          const data_admissao = document.getElementById('data_admissao').value;
          const cpf = document.getElementById('cpf').value;
          const conta_inter = document.getElementById('conta_inter').value;
          const ultimo_exame = document.getElementById('ultimo_exame').value;
          const proximo_exame = document.getElementById('proximo_exame').value;
          const email = document.getElementById('email').value;
          const cargo = document.getElementById('cargo').value;
          const salario = document.getElementById('salario').value;
          const status = document.getElementById('status').value.status;
          console.log({
            status,
            nome,
            registro,
            funcao,
            data_nascimento,
            data_admissao,
            cpf,
            conta_inter,
            ultimo_exame,
            proximo_exame,
            email,
            cargo,
            salario
        });        
          const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value; // Captura o CSRF token
        
          fetch(`/update/${funcionarioId}/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken // Usando o token CSRF do input
            },
            body: JSON.stringify({
              nome,
              registro,
              funcao,
              data_nascimento,
              data_admissao,
              cpf,
              conta_inter,
              ultimo_exame,
              proximo_exame,
              email,
              cargo,
              salario,
              status
            })
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(errData => {
                throw new Error(`Error ${response.status}: ${JSON.stringify(errData.error)}`);
              });
            }
            return response.json();
          })
          .then(data => {
            alert(data.message);
            location.reload(); // Recarrega a página para ver as mudanças
          })
          .catch(error => {
            console.error('Error:', error);
            alert(error.message); // Exibe a mensagem de erro detalhada
          });
        
      }
      

      </script>

      <script src="../assets/dist/js/bootstrap.bundle.min.js"></script>
      <script src="{% static 'js/dashboard.js' %}"></script>
      <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
</body>

</html>